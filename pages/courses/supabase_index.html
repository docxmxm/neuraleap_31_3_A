<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nerualleap - Course Directory (Supabase)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
    <link href="/css/animations.css" rel="stylesheet">
</head>
<body>
    <!-- Neural network background -->
    <div class="neural-bg"></div>
    <div class="tech-lines-bg"></div>
    
    <!-- Header navigation -->
    <div id="header-container"></div>

    <!-- Page Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-white">Course <span class="neon-text">Directory</span> (Supabase)</h1>
            <p class="text-gray-400 mt-2">Discover our comprehensive AI and large model training courses</p>
        </div>

        <!-- Search and Filters -->
        <div class="flex flex-col md:flex-row gap-4 mb-8">
            <div class="flex-1">
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center">
                        <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </span>
                    <input id="course-search" class="block w-full pl-10 pr-4 py-3 rounded-lg bg-dark-card border border-gray-800 text-gray-300 focus:outline-none focus:border-cyan-400" placeholder="Search for courses...">
                </div>
            </div>

            <div class="flex space-x-4">
                <div class="relative">
                    <select id="category-filter" class="appearance-none px-4 py-3 rounded-lg bg-dark-card border border-gray-800 text-gray-300 focus:outline-none focus:border-cyan-400 pr-10">
                        <option value="">All Categories</option>
                        <option value="llm">Large Language Models</option>
                        <option value="cv">Computer Vision</option>
                        <option value="rl">Reinforcement Learning</option>
                        <option value="safety">AI Safety</option>
                        <option value="ethics">Ethics & Governance</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                        <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>

                <div class="relative">
                    <select id="level-filter" class="appearance-none px-4 py-3 rounded-lg bg-dark-card border border-gray-800 text-gray-300 focus:outline-none focus:border-cyan-400 pr-10">
                        <option value="">All Levels</option>
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                        <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>

                <div class="relative">
                    <select id="sort-option" class="appearance-none px-4 py-3 rounded-lg bg-dark-card border border-gray-800 text-gray-300 focus:outline-none focus:border-cyan-400 pr-10">
                        <option value="relevance">Sort by Relevance</option>
                        <option value="newest">Newest First</option>
                        <option value="popular">Most Popular</option>
                        <option value="price_low">Price: Low to High</option>
                        <option value="price_high">Price: High to Low</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                        <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories Quick Jump -->
        <div class="flex flex-wrap gap-2 mb-8">
            <button class="category-filter px-4 py-2 text-sm rounded-full bg-blue-900 text-white hover:bg-blue-800 transition-colors" data-category="">All Categories</button>
            <button class="category-filter px-4 py-2 text-sm rounded-full border border-gray-700 text-gray-300 hover:text-cyan-400 hover:border-cyan-400 transition-colors" data-category="llm">Large Language Models</button>
            <button class="category-filter px-4 py-2 text-sm rounded-full border border-gray-700 text-gray-300 hover:text-cyan-400 hover:border-cyan-400 transition-colors" data-category="cv">Computer Vision</button>
            <button class="category-filter px-4 py-2 text-sm rounded-full border border-gray-700 text-gray-300 hover:text-cyan-400 hover:border-cyan-400 transition-colors" data-category="rl">Reinforcement Learning</button>
            <button class="category-filter px-4 py-2 text-sm rounded-full border border-gray-700 text-gray-300 hover:text-cyan-400 hover:border-cyan-400 transition-colors" data-category="safety">AI Safety</button>
            <button class="category-filter px-4 py-2 text-sm rounded-full border border-gray-700 text-gray-300 hover:text-cyan-400 hover:border-cyan-400 transition-colors" data-category="ethics">Ethics & Governance</button>
        </div>

        <!-- Loading indicator -->
        <div id="loading" class="text-center py-12">
            <svg class="animate-spin h-10 w-10 text-cyan-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-400">Loading courses...</p>
        </div>

        <!-- Course Grid -->
        <div id="courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10 hidden">
            <!-- Courses will be dynamically inserted here -->
        </div>

        <!-- Pagination -->
        <div id="pagination" class="flex justify-center hidden">
            <nav class="flex space-x-2">
                <a href="#" class="pagination-prev px-3 py-2 rounded-md text-gray-400 hover:text-white hover:bg-dark-card transition-colors">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </a>
                <div id="page-buttons" class="flex space-x-2">
                    <!-- Page buttons will be inserted here -->
                </div>
                <a href="#" class="pagination-next px-3 py-2 rounded-md text-gray-400 hover:text-white hover:bg-dark-card transition-colors">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </a>
            </nav>
        </div>
    </div>

    <!-- Footer container -->
    <div id="footer-container"></div>

    <!-- Load Components and Scripts -->
    <script src="/js/main.js"></script>
    <script>
        // Load header and footer
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/components/header.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('header-container').innerHTML = data;
                });
                
            fetch('/components/footer.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('footer-container').innerHTML = data;
                });
                
            // Initialize course loading
            initCoursesPage();
        });
        
        function initCoursesPage() {
            const loadingElement = document.getElementById('loading');
            const coursesGrid = document.getElementById('courses-grid');
            const paginationElement = document.getElementById('pagination');
            const courseSearch = document.getElementById('course-search');
            const categoryFilter = document.getElementById('category-filter');
            const levelFilter = document.getElementById('level-filter');
            const sortOption = document.getElementById('sort-option');
            const pageButtons = document.getElementById('page-buttons');
            
            // API URL and key
            const apiUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                ? 'http://127.0.0.1:54321' 
                : 'https://txggovndoxdybdquopvx.supabase.co';
            const apiKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4Z2dvdm5kb3hkeWJkcXVvcHZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE1Nzg3MTMsImV4cCI6MjA1NzE1NDcxM30.p0l-YAdIjq-ICQNRGt5bN6YkrSB4NVDMaBUFYH4fpL4';
            
            // Pagination state
            const pageSize = 6;
            let currentPage = 1;
            let totalPages = 1;
            let allCourses = [];
            let filteredCourses = [];
            
            // Fetch courses from Supabase
            async function fetchCourses() {
                try {
                    // Use a simple query parameter to avoid auth checks
                    const response = await fetch(`${apiUrl}/rest/v1/courses?select=id,title,description,image_url,price,is_active,category,level,rating,enrolled_count,created_at&is_active=eq.true`, {
                        headers: {
                            'apikey': apiKey,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    allCourses = await response.json();
                    console.log("Fetched courses:", allCourses);
                    
                    // Apply initial filters
                    filterCourses();
                } catch (error) {
                    console.error('Error fetching courses:', error);
                    loadingElement.innerHTML = `<p class="text-red-500">Error loading courses: ${error.message}</p>`;
                }
            }
            
            // Filter courses based on search input and filters
            function filterCourses() {
                const searchTerm = courseSearch.value.toLowerCase();
                const categoryValue = categoryFilter.value;
                const levelValue = levelFilter.value;
                const sortValue = sortOption.value;
                
                // Filter courses
                filteredCourses = allCourses.filter(course => {
                    // Filter by search term (in title or description)
                    const matchesSearch = 
                        (course.title && course.title.toLowerCase().includes(searchTerm)) || 
                        (course.description && course.description.toLowerCase().includes(searchTerm));
                    
                    // Filter by category (assuming courses have a category property)
                    // If no category is selected, show all courses
                    const matchesCategory = !categoryValue || (course.category === categoryValue);
                    
                    // Filter by level (assuming courses have a level property)
                    // If no level is selected, show all courses
                    const matchesLevel = !levelValue || (course.level === levelValue);
                    
                    return matchesSearch && matchesCategory && matchesLevel;
                });
                
                // Sort courses
                filteredCourses.sort((a, b) => {
                    switch (sortValue) {
                        case 'newest':
                            return new Date(b.created_at || 0) - new Date(a.created_at || 0);
                        case 'popular':
                            return (b.enrolled_count || 0) - (a.enrolled_count || 0);
                        case 'price_low':
                            return (parseFloat(a.price) || 0) - (parseFloat(b.price) || 0);
                        case 'price_high':
                            return (parseFloat(b.price) || 0) - (parseFloat(a.price) || 0);
                        default: // relevance
                            return 0;
                    }
                });
                
                // Update pagination
                totalPages = Math.ceil(filteredCourses.length / pageSize);
                
                // Make sure current page is valid
                if (currentPage > totalPages) {
                    currentPage = Math.max(1, totalPages);
                }
                
                // Display courses for current page
                displayCourses();
                
                // Update pagination UI
                updatePagination();
            }
            
            // Display courses for the current page
            function displayCourses() {
                // Hide loading, show grid
                loadingElement.classList.add('hidden');
                coursesGrid.classList.remove('hidden');
                
                if (filteredCourses.length === 0) {
                    coursesGrid.innerHTML = `
                        <div class="col-span-3 text-center py-12">
                            <p class="text-gray-400">No courses found matching your criteria.</p>
                        </div>
                    `;
                    paginationElement.classList.add('hidden');
                    return;
                }
                
                // Calculate slice for current page
                const startIndex = (currentPage - 1) * pageSize;
                const endIndex = Math.min(startIndex + pageSize, filteredCourses.length);
                const coursesForPage = filteredCourses.slice(startIndex, endIndex);
                
                // Show pagination if we have more than one page
                if (totalPages > 1) {
                    paginationElement.classList.remove('hidden');
                } else {
                    paginationElement.classList.add('hidden');
                }
                
                // Clear existing courses
                coursesGrid.innerHTML = '';
                
                // Add each course to the grid
                coursesForPage.forEach(course => {
                    const courseCard = document.createElement('div');
                    courseCard.className = 'card-bg rounded-xl overflow-hidden group';
                    courseCard.innerHTML = `
                        <div class="h-48 bg-gradient-to-r from-blue-900 to-cyan-900 relative overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-r from-blue-900 to-cyan-900 opacity-90 group-hover:opacity-70 transition-opacity"></div>
                            
                            <div class="absolute inset-0 flex items-center justify-center">
                                <svg class="text-white h-16 w-16 opacity-90" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>
                            </div>
                            
                            <div class="absolute top-4 left-4 bg-black bg-opacity-50 text-cyan-400 px-3 py-1 rounded-full text-xs font-medium">
                                ${course.level || 'All Levels'}
                            </div>
                            
                            <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="bg-white text-blue-900 px-4 py-2 rounded-lg font-medium hover:bg-cyan-400 transition-colors">
                                    Preview Course
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-xs font-medium px-2 py-1 bg-blue-900 bg-opacity-30 text-cyan-400 rounded">${course.category || 'General'}</span>
                                <div class="flex items-center">
                                    <svg class="h-4 w-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                    <span class="text-gray-400 text-sm ml-1">${course.rating || '4.5'}</span>
                                </div>
                            </div>
                            
                            <h3 class="text-xl font-bold text-white mb-2">${course.title}</h3>
                            
                            <p class="text-gray-400 text-sm mb-4">${course.description || 'No description available'}</p>
                            
                            <div class="flex justify-between items-center">
                                <span class="text-2xl font-bold text-white">$${parseFloat(course.price || 0).toFixed(2)}</span>
                                <button class="neon-button px-4 py-2 rounded-lg text-sm">Enroll Now</button>
                            </div>
                        </div>
                    `;
                    
                    coursesGrid.appendChild(courseCard);
                });
            }
            
            // Update pagination UI
            function updatePagination() {
                pageButtons.innerHTML = '';
                
                // Determine the range of pages to show
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, startPage + 4);
                
                // Adjust start if end is too small
                if (endPage - startPage < 4) {
                    startPage = Math.max(1, endPage - 4);
                }
                
                // Create page buttons
                for (let i = startPage; i <= endPage; i++) {
                    const pageButton = document.createElement('a');
                    pageButton.href = '#';
                    pageButton.className = i === currentPage 
                        ? 'px-3 py-2 rounded-md bg-blue-900 text-white' 
                        : 'px-3 py-2 rounded-md text-gray-400 hover:text-white hover:bg-dark-card transition-colors';
                    pageButton.textContent = i;
                    pageButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        currentPage = i;
                        displayCourses();
                        updatePagination();
                    });
                    
                    pageButtons.appendChild(pageButton);
                }
                
                // Setup previous/next buttons
                const prevButton = document.querySelector('.pagination-prev');
                const nextButton = document.querySelector('.pagination-next');
                
                prevButton.classList.toggle('opacity-50', currentPage === 1);
                prevButton.classList.toggle('pointer-events-none', currentPage === 1);
                
                nextButton.classList.toggle('opacity-50', currentPage === totalPages);
                nextButton.classList.toggle('pointer-events-none', currentPage === totalPages);
                
                prevButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentPage > 1) {
                        currentPage--;
                        displayCourses();
                        updatePagination();
                    }
                });
                
                nextButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentPage < totalPages) {
                        currentPage++;
                        displayCourses();
                        updatePagination();
                    }
                });
            }
            
            // Set up event listeners
            courseSearch.addEventListener('input', debounce(() => {
                currentPage = 1;
                filterCourses();
            }, 300));
            
            categoryFilter.addEventListener('change', () => {
                currentPage = 1;
                filterCourses();
            });
            
            levelFilter.addEventListener('change', () => {
                currentPage = 1;
                filterCourses();
            });
            
            sortOption.addEventListener('change', () => {
                currentPage = 1;
                filterCourses();
            });
            
            // Category quick jump buttons
            document.querySelectorAll('.category-filter').forEach(button => {
                button.addEventListener('click', () => {
                    const category = button.dataset.category;
                    categoryFilter.value = category;
                    
                    // Update active state
                    document.querySelectorAll('.category-filter').forEach(btn => {
                        btn.classList.remove('bg-blue-900', 'text-white');
                        btn.classList.add('border', 'border-gray-700', 'text-gray-300');
                    });
                    
                    button.classList.remove('border', 'border-gray-700', 'text-gray-300');
                    button.classList.add('bg-blue-900', 'text-white');
                    
                    currentPage = 1;
                    filterCourses();
                });
            });
            
            // Debounce helper function
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            // Initial fetch
            fetchCourses();
            
            // Add a test button to verify RLS
            const testDiv = document.createElement('div');
            testDiv.className = 'mt-8 p-4 bg-dark-card rounded-lg';
            testDiv.innerHTML = `
                <h3 class="text-xl text-white mb-2">Test Anonymous Access</h3>
                <button id="test-anon" class="px-4 py-2 bg-blue-600 text-white rounded">Test Anonymous Access</button>
                <div id="test-result" class="mt-4 text-gray-300 p-4 bg-gray-900 rounded overflow-auto" style="max-height: 300px">
                    Click the button to test...
                </div>
            `;
            document.querySelector('.max-w-7xl').appendChild(testDiv);
            
            document.getElementById('test-anon').addEventListener('click', async () => {
                const resultElement = document.getElementById('test-result');
                resultElement.textContent = 'Testing anonymous access...';
                
                try {
                    const anonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0';
                    const response = await fetch(`${apiUrl}/rest/v1/courses?select=*`, {
                        headers: {
                            'apikey': anonKey,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        resultElement.innerHTML = '<span class="text-green-500">✓ Anonymous access works!</span><br>' + 
                            '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                    } else {
                        resultElement.innerHTML = '<span class="text-red-500">✗ Anonymous access failed</span><br>' + 
                            '<pre>' + await response.text() + '</pre>';
                    }
                } catch (error) {
                    resultElement.innerHTML = '<span class="text-red-500">✗ Error:</span> ' + error.message;
                }
            });
        }
    </script>
</body>
</html> 